{{- /* This is an enhanced version of the LoveIt theme's cookie consent with Microsoft Clarity Consent V2 API */ -}}

{{- /* Cookie Consent */ -}}
{{- if .Site.Params.cookieconsent | and .Site.Params.cookieconsent.enable -}}
    {{- $source := $cdn.cookieconsentCSS | default "lib/cookieconsent/cookieconsent.min.css" -}}
    {{- dict "Source" $source "Fingerprint" $fingerprint | dict "Scratch" .Scratch "Data" | partial "scratch/style.html" -}}
    {{- $source := $cdn.cookieconsentJS | default "lib/cookieconsent/cookieconsent.min.js" -}}
    {{- dict "Source" $source "Fingerprint" $fingerprint | dict "Scratch" .Scratch "Data" | partial "scratch/script.html" -}}

    {{- $cookieconsentConfig := dict "popup" (dict "background" "#1aa3ff") "button" (dict "background" "#f0f0f0") | dict "theme" "edgeless" "palette" -}}
    {{- $cookieconsentConfig = .Site.Params.cookieconsent | merge $cookieconsentConfig -}}
    {{- $cookieconsentConfig = dict "message" ($cookieconsentConfig.content.message | default (T "cookieconsentMessage")) "dismiss" ($cookieconsentConfig.content.dismiss | default (T "cookieconsentDismiss")) "link" ($cookieconsentConfig.content.link | default (T "cookieconsentLink")) | dict "content" | merge $cookieconsentConfig -}}

    {{- /* Add reject button and Microsoft Clarity consent handling */ -}}
    {{- $cookieconsentConfig = dict "deny" ($cookieconsentConfig.content.reject | default "Reject") | dict "content" | merge $cookieconsentConfig -}}
    {{- $cookieconsentConfig = dict "type" "opt-in" | merge $cookieconsentConfig -}}

    {{- /* Add custom callbacks for Microsoft Clarity Consent V2 */ -}}
    {{- $clarityCallbacks := dict -}}
    {{- if and .Site.Params.analytics.enable .Site.Params.analytics.clarity.enable .Site.Params.analytics.clarity.id -}}
        {{- $clarityCallbacks = dict "onInitialise" "function(status) { if (status === 'allow') { window.clarity && window.clarity('consentv2', { ad_Storage: 'granted', analytics_Storage: 'granted' }); } }" -}}
        {{- $clarityCallbacks = dict "onStatusChange" "function(status, chosenBefore) { if (status === 'allow') { window.clarity && window.clarity('consentv2', { ad_Storage: 'granted', analytics_Storage: 'granted' }); } else if (status === 'deny') { window.clarity && window.clarity('consentv2', { ad_Storage: 'denied', analytics_Storage: 'denied' }); } }" | merge $clarityCallbacks -}}
        {{- $clarityCallbacks = dict "onRevokeChoice" "function() { window.clarity && window.clarity('consent', false); }" | merge $clarityCallbacks -}}
        {{- $cookieconsentConfig = $clarityCallbacks | merge $cookieconsentConfig -}}
    {{- end -}}

    {{- $config = $cookieconsentConfig | dict "cookieconsent" | merge $config -}}
{{- end -}}
